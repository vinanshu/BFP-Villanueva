<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ML Profile - Bureau of Fire Protection</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Orbitron', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: row;
      background-color: #000;
      color: #fff;
    }

    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 240px;
      background: linear-gradient(135deg, #0d1a2f, #1c2b4b);
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      gap: 25px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.5);
      z-index: 100;
    }

    .sidebar h2 {
      color: #00bfff;
      font-size: 24px;
      text-align: center;
      margin-bottom: 30px;
    }

    .sidebar a {
      text-decoration: none;
      color: #fff;
      font-size: 16px;
      padding: 12px;
      border-radius: 8px;
      transition: 0.3s;
      background-color: transparent;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #00bfff;
      color: #000;
      font-weight: bold;
    }

    .main-content {
      margin-left: 240px;
      padding: 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      background: url('/assets/img/ml-bg.jpg') center center / cover no-repeat;
      min-height: 100vh;
      color: #fff;
      position: relative;
    }

    .game-bar {
      width: 100%;
      background: rgba(0,0,0,0.75);
      padding: 20px 40px;
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      border-bottom: 3px solid #00bfff;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #00bfff;
    }

    .profile-card {
      margin: 40px auto;
      max-width: 900px;
      background-color: rgba(0,0,0,0.65);
      border-radius: 20px;
      padding: 30px;
      display: flex;
      gap: 30px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 0 15px #00bfff;
    }

    .profile-photo {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #00bfff;
      background-color: #222;
      box-shadow: 0 0 10px #00bfff;
    }

    .profile-info {
      flex: 1;
    }

    .profile-info h2 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #00d8ff;
    }

    .profile-info p {
      margin: 5px 0;
      color: #e0f7ff;
    }

    .profile-info p strong {
      color: #00bfff;
    }

    .lists-wrapper {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      margin: 20px auto;
      max-width: 960px;
    }

    .equipment-list, .clearance-list {
      flex: 1 1 420px;
    }

    .equipment-list table, .clearance-list table {
      width: 100%;
      border-collapse: collapse;
      background-color: rgba(0,0,0,0.65);
      color: #fff;
      box-shadow: 0 0 10px #00bfff;
      border-radius: 10px;
      overflow: hidden;
    }

    .equipment-list th, .equipment-list td,
    .clearance-list th, .clearance-list td {
      padding: 10px;
      text-align: left;
    }

    .equipment-list thead tr,
    .clearance-list thead tr {
      background-color: #00bfff;
      color: #000;
    }

    .equipment-list tbody tr:nth-child(even),
    .clearance-list tbody tr:nth-child(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .download-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .download-buttons button {
      background: #00bfff;
      color: #000;
      font-weight: bold;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 0 10px #00bfff;
      transition: 0.3s;
    }

    .download-buttons button:hover {
      background: #00a3cc;
      box-shadow: 0 0 20px #00d8ff;
      transform: scale(1.05);
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        padding: 10px;
        justify-content: space-around;
      }

      .main-content {
        margin-left: 0;
      }

      .profile-card {
        flex-direction: column;
        text-align: center;
      }

      .lists-wrapper {
        flex-direction: column;
        align-items: center;
      }

      .download-buttons {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <nav class="sidebar">
    <h2>üî• BFP </h2>
    <a href="/employee.html" class="active">üë§ Profile</a>
    <a href="/employeeDashboard.html">üìä Dashboard</a>
    <a href="/employeeRequest.html">üìù Leave</a>
    <a href="/index.html">üö™ Logout</a>
  </nav>

  <main class="main-content">
    <div class="game-bar">EMPLOYEE PROFILE</div>

    <section class="profile-card" id="profile-card">
      <img src="" alt="Employee Photo" class="profile-photo" id="profile-photo" />
      <div class="profile-info" id="profile-info">
        <h2>Loading...</h2>
      </div>
    </section>

    <div class="lists-wrapper">
      <section class="equipment-list" id="equipment-list">
        <h2 style="text-align: center; color: #00bfff; margin-bottom: 15px;">Assigned Equipment</h2>
        <table>
          <thead>
            <tr>
              <th>Equipment Name</th>
              <th>Barcode/Item Code</th>
              <th>Category</th>
              <th>Purchase Date</th>
            </tr>
          </thead>
          <tbody id="equipment-body"></tbody>
        </table>
      </section>

      <section class="clearance-list" id="clearance-list">
        <h2 style="text-align: center; color: #00bfff; margin-bottom: 15px;">Clearance Requests</h2>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="clearance-body"></tbody>
        </table>
      </section>
    </div>

    <div class="download-buttons">
      <button id="downloadLeaveForm">üì• Download Leave Form</button>
      <button id="downloadClearance">üì• Download Clearance</button>
    </div>
  </main>

  <script>
    function loadEmployeeProfile() {
      const currentUser = localStorage.getItem("currentUser");
      if (!currentUser) {
        alert("No user logged in. Redirecting...");
        window.location.href = "/index.html";
        return;
      }

      const personnelList = JSON.parse(localStorage.getItem("personnelList")) || [];
      const employee = personnelList.find(p => p.username === currentUser);

      if (!employee) {
        document.getElementById("profile-info").innerHTML = "<p>Employee not found.</p>";
        document.getElementById("profile-photo").src = "/employee/img/default-profile.png";
        return;
      }

      renderEmployeeProfile(employee);
      loadAssignedEquipment(employee);
      loadClearanceRequests(employee);
    }

    function renderEmployeeProfile(emp) {
      const photoElem = document.getElementById("profile-photo");
      photoElem.src = emp.photo && emp.photo.startsWith("data:image") ? emp.photo : "/employee/img/default-profile.png";
      photoElem.alt = `${emp.rank} ${emp.firstName} ${emp.lastName}'s photo`;
      document.getElementById("profile-info").innerHTML = `
        <h2>${emp.rank} ${emp.firstName} ${emp.middleName} ${emp.lastName}</h2>
        <p><strong>Badge Number:</strong> ${emp.badgeNumber}</p>
        <p><strong>Rank:</strong> ${emp.rank}</p>
        <p><strong>Designation:</strong> ${emp.designation}</p>
        <p><strong>Station:</strong> ${emp.station}</p>
        <p><strong>Birth Date:</strong> ${emp.birthDate}</p>
        <p><strong>Date Hired:</strong> ${emp.dateHired}</p>
        <p><strong>Username:</strong> ${emp.username}</p>`;
    }

    function loadAssignedEquipment(emp) {
      const fullName = `${emp.firstName} ${emp.middleName || ''} ${emp.lastName}`.replace(/\s+/g, ' ').trim();
      const inventory = JSON.parse(localStorage.getItem("inventory")) || [];
      const assignedItems = inventory.filter(item => item.assignedTo === fullName);
      const tbody = document.getElementById("equipment-body");

      if (assignedItems.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 15px;">No equipment assigned.</td></tr>`;
        return;
      }

      tbody.innerHTML = assignedItems.map(item => `
        <tr>
          <td>${item.name}</td>
          <td>${item.itemCode}</td>
          <td>${item.category}</td>
          <td>${item.purchaseDate}</td>
        </tr>
      `).join('');
    }

    function loadClearanceRequests(emp) {
      const fullName = `${emp.firstName} ${emp.middleName || ''} ${emp.lastName}`.replace(/\s+/g, ' ').trim();
      const clearanceList = JSON.parse(localStorage.getItem("clearanceRequests")) || [];
      const userClearances = clearanceList.filter(c => c.employee === fullName);
      const tbody = document.getElementById("clearance-body");

      if (userClearances.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align: center; padding: 15px;">No clearance requests found.</td></tr>`;
        return;
      }

      tbody.innerHTML = userClearances.map(c => `
        <tr>
          <td>${c.date}</td>
          <td>${c.type}</td>
          <td>${c.status}</td>
        </tr>
      `).join('');
    }

    document.getElementById("downloadLeaveForm").addEventListener("click", () => {
      window.open("/employee/forms/leave-form.pdf", "_blank");
    });

    document.getElementById("downloadClearance").addEventListener("click", () => {
      window.open("/employee/forms/clearance-form.pdf", "_blank");
    });

    window.onload = loadEmployeeProfile;
  </script>
</body>
</html>
